{% extends 'base.html.twig' %}

{% block title %}Contrat {{ contract.type }} - {{ contract.user.fullName }} - RH NewLife{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50 p-8">
    <div class="max-w-5xl mx-auto">

        {# Header #}
        <div class="flex items-start justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Contrat {{ contract.type }}</h1>
                <p class="text-gray-600 mt-1">
                    {{ contract.user.fullName }} ({{ contract.user.matricule }})
                    {% if contract.isAmendment %}
                        <span class="badge badge-warning ml-2">Avenant version {{ contract.version }}</span>
                    {% endif %}
                </p>
            </div>

            <div>
                {% if contract.status == 'draft' %}
                    <span class="badge badge-neutral badge-lg">Brouillon</span>
                {% elseif contract.status == 'active' %}
                    <span class="badge badge-success badge-lg">Actif</span>
                {% elseif contract.status == 'signed' %}
                    <span class="badge badge-info badge-lg">Signé</span>
                {% elseif contract.status == 'terminated' %}
                    <span class="badge badge-neutral badge-lg">Terminé</span>
                {% endif %}
            </div>
        </div>

        {# Flash messages #}
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label == 'error' ? 'error' : (label == 'success' ? 'success' : 'info') }} mb-6">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        {# Actions rapides #}
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Actions</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                {% if contract.status == 'draft' %}
                    <a href="{{ path('app_admin_contracts_edit', {id: contract.id}) }}" class="btn btn-secondary justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Modifier
                    </a>

                    <form method="post" action="{{ path('app_admin_contracts_validate', {id: contract.id}) }}" class="w-full">
                        <button type="submit" class="btn btn-success w-full justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            Valider
                        </button>
                    </form>
                {% endif %}

                {% if contract.status in ['active', 'signed'] %}
                    <form method="post" action="{{ path('app_admin_contracts_send_to_accounting', {id: contract.id}) }}" class="w-full">
                        <button type="submit" class="btn btn-info w-full justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            Envoyer compta
                        </button>
                    </form>
                {% endif %}

                {% if contract.status == 'active' %}
                    <button onclick="document.getElementById('upload-modal').classList.remove('hidden')" class="btn btn-primary justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        Upload signé
                    </button>
                {% endif %}

                {% if contract.status in ['active', 'signed'] %}
                    <a href="{{ path('app_admin_contracts_create_amendment', {id: contract.id}) }}" class="btn btn-warning justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Avenant
                    </a>

                    <a href="{{ path('app_admin_contracts_close', {id: contract.id}) }}" class="btn btn-outline-danger justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        Clôturer
                    </a>
                {% endif %}
            </div>
        </div>

        {# Détails du contrat #}
        <div class="grid grid-cols-2 gap-6 mb-6">
            {# Informations principales #}
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">Informations du contrat</h2>
                <dl class="space-y-3">
                    <div>
                        <dt class="text-sm text-gray-500">Type</dt>
                        <dd class="font-semibold text-gray-900">{{ contract.type }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm text-gray-500">Période</dt>
                        <dd class="text-gray-900">
                            Du {{ contract.startDate|date('d/m/Y') }}
                            {% if contract.endDate %}
                                au {{ contract.endDate|date('d/m/Y') }}
                            {% else %}
                                (CDI)
                            {% endif %}
                        </dd>
                    </div>
                    {% if contract.essaiEndDate %}
                        <div>
                            <dt class="text-sm text-gray-500">Période d'essai</dt>
                            <dd class="text-gray-900">Jusqu'au {{ contract.essaiEndDate|date('d/m/Y') }}</dd>
                        </div>
                    {% endif %}
                    <div>
                        <dt class="text-sm text-gray-500">Version</dt>
                        <dd class="text-gray-900">{{ contract.version }}</dd>
                    </div>
                </dl>
            </div>

            {# Rémunération #}
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">Rémunération</h2>
                <dl class="space-y-3">
                    <div>
                        <dt class="text-sm text-gray-500">Salaire de base (brut)</dt>
                        <dd class="font-bold text-xl text-gray-900">{{ contract.baseSalary }} €</dd>
                    </div>
                    <div>
                        <dt class="text-sm text-gray-500">Salaire net estimé</dt>
                        <dd class="text-gray-900">{{ contract.estimatedNetSalary }} €</dd>
                    </div>
                    <div>
                        <dt class="text-sm text-gray-500">Taux d'activité</dt>
                        <dd class="text-gray-900">{{ (contract.activityRate * 100)|number_format(0) }}%</dd>
                    </div>
                    <div>
                        <dt class="text-sm text-gray-500">Heures hebdomadaires</dt>
                        <dd class="text-gray-900">{{ contract.weeklyHours }}h</dd>
                    </div>
                </dl>
            </div>
        </div>

        {# Informations complémentaires #}
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Autres informations</h2>
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <dt class="text-sm text-gray-500 mb-1">Villa affectée</dt>
                    <dd class="text-gray-900">{{ contract.villa ?? 'Non affecté' }}</dd>
                </div>
                <div>
                    <dt class="text-sm text-gray-500 mb-1">Jours travaillés</dt>
                    <dd class="text-gray-900">
                        {% if contract.workingDays %}
                            {{ contract.workingDays|join(', ') }}
                        {% else %}
                            Non renseigné
                        {% endif %}
                    </dd>
                </div>
            </div>
        </div>

        {# Statut et historique #}
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Statut et historique</h2>
            <div class="space-y-3">
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900">Créé le {{ contract.createdAt|date('d/m/Y à H:i') }}</p>
                    </div>
                </div>

                {% if contract.validatedAt %}
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-900">Validé le {{ contract.validatedAt|date('d/m/Y à H:i') }}</p>
                        </div>
                    </div>
                {% endif %}

                {% if contract.signedAt %}
                    <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-900">Signé le {{ contract.signedAt|date('d/m/Y à H:i') }}</p>
                        </div>
                    </div>
                {% endif %}

                {% if contract.status == 'terminated' %}
                    <div class="flex items-center gap-3 p-3 bg-red-50 rounded-lg">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-900">Terminé le {{ contract.terminatedAt|date('d/m/Y') }}</p>
                            {% if contract.terminationReason %}
                                <p class="text-sm text-gray-600">Raison: {{ contract.terminationReason }}</p>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        {# Retour #}
        <div class="mt-6">
            <a href="{{ path('app_admin_users_view', {id: contract.user.id}) }}" class="text-blue-600 hover:text-blue-800 font-semibold inline-flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Retour à la fiche salarié
            </a>
        </div>

    </div>
</div>

{# Modal upload contrat signé #}
<div id="upload-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-gray-900 mb-4">Upload contrat signé</h3>
        <form method="post" action="{{ path('app_admin_contracts_upload_signed', {id: contract.id}) }}" enctype="multipart/form-data">
            <div class="mb-6">
                <label class="form-label">Fichier PDF signé *</label>
                <input type="file" name="signed_contract" accept=".pdf" class="form-input" required>
                <p class="text-xs text-gray-500 mt-1">Format PDF uniquement</p>
            </div>
            <div class="flex gap-3 justify-end">
                <button type="button" onclick="document.getElementById('upload-modal').classList.add('hidden')" class="btn btn-secondary">
                    Annuler
                </button>
                <button type="submit" class="btn btn-primary">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    Upload
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
