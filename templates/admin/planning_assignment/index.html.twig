{% extends 'admin.html.twig' %}

{% block title %}Affectation des Gardes{% endblock %}

{% block admin_title %}Affectation des Gardes{% endblock %}
{% block admin_subtitle %}Assignation des √©ducateurs aux cr√©neaux de garde{% endblock %}

{% block admin_content %}
<div data-controller="planning-assignment"
     data-planning-assignment-current-year-value="{{ currentYear }}"
     data-planning-assignment-current-month-value="{{ currentMonth }}">

    {# Action buttons inside Stimulus controller scope #}
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-800">Planning du mois</h2>
            <div class="flex space-x-2">
                <button data-action="click->planning-assignment#openGenerateModal"
                        type="button"
                        class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-150">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    G√©n√©rer un squelette
                </button>

                {# üÜï Bouton Sauvegarder #}
                <button data-action="click->planning-assignment#manualSave"
                        data-planning-assignment-target="saveButton"
                        type="button"
                        class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition duration-150">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                    Sauvegarder
                </button>

                {# üÜï Bouton Supprimer toutes gardes non valid√©es #}
                <button data-action="click->planning-assignment#openBulkDeleteModal"
                        type="button"
                        class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition duration-150">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Nettoyer brouillon
                </button>

                <button data-action="click->planning-assignment#validatePlanning"
                        type="button"
                        class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-150">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Valider le planning
                </button>
            </div>
        </div>

        {# üÜï Indicateur modifications non sauvegard√©es #}
        <div id="unsaved-indicator" class="hidden mt-3 px-4 py-2 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg text-sm flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <span>0 modifications non sauvegard√©es</span>
        </div>
    </div>

    {# Month Selector #}
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <label class="text-sm font-medium text-gray-700">P√©riode :</label>
                <select data-planning-assignment-target="monthSelector"
                        data-action="change->planning-assignment#loadMonth"
                        class="rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    {% for month in 1..12 %}
                        <option value="{{ currentYear }}-{{ '%02d'|format(month) }}"
                                {% if month == currentMonth %}selected{% endif %}>
                            {{ ('month.' ~ month)|trans }} {{ currentYear }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="text-sm text-gray-500">
                <span class="font-medium">L√©gende :</span>
                <span class="inline-block ml-2 px-2 py-1 bg-gray-100 rounded">Fond = √âducateur</span>
                <span class="inline-block ml-2 px-2 py-1 bg-gray-100 rounded">Bordure = Villa/Type</span>
                <span class="inline-block ml-2 px-2 py-1 bg-gray-100 rounded">
                    Statuts :
                    <span class="inline-block px-1.5 py-0.5 ml-1 rounded text-white" style="background: #9CA3AF;">üìù Brouillon</span>
                    <span class="inline-block px-1.5 py-0.5 ml-1 rounded text-white" style="background: #10B981;">‚úì Valid√©</span>
                    <span class="inline-block px-1.5 py-0.5 ml-1 rounded text-white" style="background: #F59E0B;">‚ö† √Ä remplacer</span>
                </span>
            </div>
        </div>
    </div>

    {# Main Layout: Sidebar + Calendar #}
    <div class="grid grid-cols-12 gap-6">
        {# Educators Sidebar (col-3) #}
        <div class="col-span-3">
            <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    √âducateurs
                </h3>

                <div data-planning-assignment-target="usersSidebar" class="space-y-2">
                    {% include 'admin/planning_assignment/_users_sidebar.html.twig' %}
                </div>
            </div>
        </div>

        {# FullCalendar (col-9) #}
        <div class="col-span-9">
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div data-planning-assignment-target="calendar" class="h-screen"></div>
            </div>
        </div>
    </div>

    {# Generate Modal #}
    {% include 'admin/planning_assignment/_generate_modal.html.twig' %}

</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {# FullCalendar will be loaded via Stimulus controller #}
    <style>
        .fc-event {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease, opacity 0.2s ease !important;
            cursor: pointer;
        }

        .fc-event:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .fc-event.drag-hover {
            transform: scale(1.08) !important;
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.7), 0 0 0 4px rgba(59, 130, 246, 0.3) !important;
            border-style: solid !important;
            z-index: 100 !important;
            opacity: 1 !important;
        }

        /* Sidebar card dragging state */
        .educateur-card.dragging {
            opacity: 0.4;
            border: 2px dashed #3B82F6 !important;
            transform: scale(0.95);
        }

        /* Style for the day being hovered by FC default */
        .fc-day-highlight {
            background-color: rgba(59, 130, 246, 0.03) !important;
        }

        /* Custom event content styling */
        .fc-event-main-custom {
            padding: 4px 6px;
            overflow: hidden;
        }

        .fc-event .fc-event-main {
            padding: 0 !important;
        }

        /* Improve readability on small events */
        .fc-daygrid-event {
            padding: 2px 4px !important;
        }

        .fc-daygrid-event-harness {
            margin-top: 1px !important;
            margin-bottom: 1px !important;
        }
    </style>
{% endblock %}
