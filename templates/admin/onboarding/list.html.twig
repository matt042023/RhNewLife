{% extends 'base.html.twig' %}

{% block title %}Gestion des Onboardings - RH NewLife{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50 p-8">
	<div class="max-w-7xl mx-auto">

		{# Header #}
		<div class="flex items-center justify-between mb-8">
			<div>
				<h1 class="text-3xl font-bold text-gray-900">Gestion des Onboardings</h1>
				<p class="text-gray-600 mt-1">Suivez l'ensemble du processus d'intégration de vos nouveaux salariés</p>
			</div>
			<a href="{{ path('app_admin_invitations_create') }}" class="btn btn-primary">
				<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
				</svg>
				Nouvelle invitation
			</a>
		</div>

		{# Flash messages #}
		{% for label, messages in app.flashes %}
			{% for message in messages %}
				<div class="alert alert-{{ label == 'error' ? 'error' : (label == 'success' ? 'success' : 'info') }} mb-4">
					{{ message }}
				</div>
			{% endfor %}
		{% endfor %}

		{# Statistiques #}
		<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
			<a href="{{ path('app_admin_onboarding_list') }}" class="card hover:shadow-lg transition {{ currentFilter is null ? 'ring-2 ring-blue-500' : '' }}">
				<div class="text-center">
					<p class="text-sm text-gray-600 mb-1">Total</p>
					<p class="text-3xl font-bold text-gray-900">{{ stats.total }}</p>
				</div>
			</a>

			<a href="{{ path('app_admin_onboarding_list', {filter: 'en_attente_activation'}) }}" class="card hover:shadow-lg transition {{ currentFilter == 'en_attente_activation' ? 'ring-2 ring-yellow-500' : '' }}">
				<div class="text-center">
					<p class="text-sm text-gray-600 mb-1">En attente</p>
					<p class="text-3xl font-bold text-yellow-600">{{ stats.en_attente_activation }}</p>
				</div>
			</a>

			<a href="{{ path('app_admin_onboarding_list', {filter: 'en_cours_onboarding'}) }}" class="card hover:shadow-lg transition {{ currentFilter == 'en_cours_onboarding' ? 'ring-2 ring-blue-500' : '' }}">
				<div class="text-center">
					<p class="text-sm text-gray-600 mb-1">En cours</p>
					<p class="text-3xl font-bold text-blue-600">{{ stats.en_cours_onboarding }}</p>
				</div>
			</a>

			<a href="{{ path('app_admin_onboarding_list', {filter: 'a_valider'}) }}" class="card hover:shadow-lg transition {{ currentFilter == 'a_valider' ? 'ring-2 ring-purple-500' : '' }}">
				<div class="text-center">
					<p class="text-sm text-gray-600 mb-1">À valider</p>
					<p class="text-3xl font-bold text-purple-600">{{ stats.a_valider }}</p>
				</div>
			</a>

			<a href="{{ path('app_admin_onboarding_list', {filter: 'valides'}) }}" class="card hover:shadow-lg transition {{ currentFilter == 'valides' ? 'ring-2 ring-green-500' : '' }}">
				<div class="text-center">
					<p class="text-sm text-gray-600 mb-1">Validés</p>
					<p class="text-3xl font-bold text-green-600">{{ stats.valides }}</p>
				</div>
			</a>

			<a href="{{ path('app_admin_onboarding_list', {filter: 'expires'}) }}" class="card hover:shadow-lg transition {{ currentFilter == 'expires' ? 'ring-2 ring-gray-500' : '' }}">
				<div class="text-center">
					<p class="text-sm text-gray-600 mb-1">Expirés</p>
					<p class="text-3xl font-bold text-gray-500">{{ stats.expires }}</p>
				</div>
			</a>
		</div>

		{# Filtres #}
		<div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
			<form method="get" class="flex gap-4">
				<div class="flex-1">
					<input type="text" name="search" value="{{ search ?? '' }}" placeholder="Rechercher par nom ou email..." class="form-input">
				</div>
				<div>
					<select name="filter" class="form-select">
						<option value="">Tous les statuts</option>
						<option value="en_attente_activation" {{ currentFilter == 'en_attente_activation' ? 'selected' : '' }}>En attente d'activation</option>
						<option value="en_cours_onboarding" {{ currentFilter == 'en_cours_onboarding' ? 'selected' : '' }}>En cours d'onboarding</option>
						<option value="a_valider" {{ currentFilter == 'a_valider' ? 'selected' : '' }}>À valider</option>
						<option value="valides" {{ currentFilter == 'valides' ? 'selected' : '' }}>Validés</option>
						<option value="expires" {{ currentFilter == 'expires' ? 'selected' : '' }}>Expirés</option>
						<option value="erreur" {{ currentFilter == 'erreur' ? 'selected' : '' }}>Erreur</option>
					</select>
				</div>
				<button type="submit" class="btn btn-secondary">
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"/>
					</svg>
					Filtrer
				</button>
			</form>
		</div>

		{# Liste des onboardings #}
		{% if invitations is empty %}
			<div class="bg-white rounded-2xl p-12 shadow-lg text-center">
				<svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 0 0 2.22 0L21 8M5 19h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2z"/>
				</svg>
				<h3 class="text-xl font-semibold text-gray-900 mb-2">Aucune invitation</h3>
				<p class="text-gray-600 mb-6">Créez votre première invitation pour commencer</p>
				<a href="{{ path('app_admin_invitations_create') }}" class="btn btn-primary inline-flex">
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
					</svg>
					Créer une invitation
				</a>
			</div>
		{% else %}
			<div class="bg-white rounded-2xl shadow-lg overflow-hidden">
				<table class="w-full">
					<thead class="bg-gray-50 border-b border-gray-200">
						<tr>
							<th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Salarié</th>
							<th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Email</th>
							<th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Poste</th>
							<th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Statut Invitation</th>
							<th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Progression</th>
							<th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Date</th>
							<th class="px-6 py-4 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
						</tr>
					</thead>
					<tbody class="divide-y divide-gray-200">
						{% for item in invitations %}
							{% set invitation = item.invitation %}
							{% set user = invitation.user %}
							{% set completionStatus = item.completionStatus %}
							{% set documentsCount = item.documentsCount %}

							<tr class="hover:bg-gray-50 transition">
								<td class="px-6 py-4">
									<div class="font-semibold text-gray-900">{{ invitation.fullName }}</div>
								</td>
								<td class="px-6 py-4 text-sm text-gray-600">{{ invitation.email }}</td>
								<td class="px-6 py-4 text-sm text-gray-600">{{ invitation.position ?? '-' }}</td>
								<td class="px-6 py-4">
									{% if invitation.status == 'pending' %}
										<span class="badge badge-warning">En attente</span>
									{% elseif invitation.status == 'used' %}
										<span class="badge badge-success">Activé</span>
									{% elseif invitation.status == 'expired' %}
										<span class="badge badge-neutral">Expiré</span>
									{% elseif invitation.status == 'error' %}
										<span class="badge badge-danger">Erreur</span>
									{% endif %}
								</td>
								<td class="px-6 py-4">
									{% if user and user.status == constant('App\\Entity\\User::STATUS_ONBOARDING') %}
										{% if user.submittedAt %}
											<span class="badge badge-purple">
												<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
												</svg>
												Prêt à valider
											</span>
										{% else %}
											<span class="badge badge-info">
												En cours ({{ documentsCount }}/4 docs)
											</span>
										{% endif %}
									{% elseif user and user.status == constant('App\\Entity\\User::STATUS_ACTIVE') %}
										<span class="badge badge-success">
											<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
											</svg>
											Validé
										</span>
									{% else %}
										<span class="text-sm text-gray-500">-</span>
									{% endif %}
								</td>
								<td class="px-6 py-4 text-sm text-gray-600">
									{% if invitation.status == 'used' and user %}
										<div class="text-xs text-gray-500">Activé le</div>
										{{ invitation.updatedAt|date('d/m/Y H:i') }}
									{% elseif invitation.status == 'pending' %}
										<div class="text-xs text-gray-500">Expire le</div>
										{{ invitation.expiresAt|date('d/m/Y H:i') }}
									{% else %}
										{{ invitation.createdAt|date('d/m/Y') }}
									{% endif %}
								</td>
								<td class="px-6 py-4 text-right">
									<div class="flex justify-end gap-2">
										{# Actions pour invitation non activée #}
										{% if invitation.status in ['pending', 'expired', 'error'] %}
											<form method="post" action="{{ path('app_admin_invitations_resend', {id: invitation.id}) }}" class="inline">
												<button type="submit" class="text-blue-600 hover:text-blue-800 text-sm font-semibold" title="Relancer l'invitation">
													Relancer
												</button>
											</form>
											<form method="post" action="{{ path('app_admin_invitations_delete', {id: invitation.id}) }}" class="inline" onsubmit="return confirm('Supprimer cette invitation ?')">
												<button type="submit" class="text-red-600 hover:text-red-800 text-sm font-semibold" title="Supprimer l'invitation">
													Supprimer
												</button>
											</form>
										{% endif %}

										{# Actions pour onboarding en cours #}
										{% if user and user.status == constant('App\\Entity\\User::STATUS_ONBOARDING') %}
											<a href="{{ path('app_admin_validation_review', {id: user.id}) }}" class="btn btn-primary btn-sm">
												{% if user.submittedAt %}
													<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
														<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
													</svg>
													Valider
												{% else %}
													<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
														<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
														<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
													</svg>
													Suivre
												{% endif %}
											</a>
										{% endif %}

										{# Actions pour utilisateur validé #}
										{% if user and user.status == constant('App\\Entity\\User::STATUS_ACTIVE') %}
											<a href="{{ path('app_admin_users_view', {id: user.id}) }}" class="btn btn-secondary btn-sm">
												<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
												</svg>
												Voir fiche
											</a>
										{% endif %}
									</div>
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		{% endif %}

		{# Retour dashboard #}
		<div class="mt-6">
			<a href="{{ path('app_dashboard') }}" class="text-blue-600 hover:text-blue-800 font-semibold inline-flex items-center gap-2">
				<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
				</svg>
				Retour au dashboard
			</a>
		</div>

	</div>
</div>
{% endblock %}
