{% extends 'admin.html.twig' %}

{% block title %}Dépôt en masse - Fiches de paie{% endblock %}

{% block admin_title %}Dépôt en masse{% endblock %}
{% block admin_subtitle %}Déposer plusieurs fiches de paie en une seule opération{% endblock %}

{% block admin_content %}
<div class="max-w-4xl mx-auto space-y-6">
    {# Instructions #}
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Instructions</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="w-10 h-10 mx-auto bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-3">
                    <span class="font-bold">1</span>
                </div>
                <h4 class="font-medium text-gray-900 mb-1">Nommage des fichiers</h4>
                <p class="text-sm text-gray-600">
                    Nommez vos fichiers avec le matricule :<br>
                    <code class="bg-gray-200 px-1 rounded">MATRICULE_2025_01.pdf</code>
                </p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="w-10 h-10 mx-auto bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-3">
                    <span class="font-bold">2</span>
                </div>
                <h4 class="font-medium text-gray-900 mb-1">Sélection</h4>
                <p class="text-sm text-gray-600">
                    Sélectionnez tous vos fichiers PDF ou glissez-les dans la zone de dépôt
                </p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="w-10 h-10 mx-auto bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-3">
                    <span class="font-bold">3</span>
                </div>
                <h4 class="font-medium text-gray-900 mb-1">Vérification</h4>
                <p class="text-sm text-gray-600">
                    Vérifiez les associations détectées puis validez le dépôt
                </p>
            </div>
        </div>
    </div>

    {# Formulaire #}
    <form method="POST" enctype="multipart/form-data" id="bulk-upload-form" class="space-y-6">
        <input type="hidden" name="_token" value="{{ csrf_token('bulk_upload') }}">

        {# Période commune #}
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Période des fiches</h3>
            <div class="grid grid-cols-2 gap-4 max-w-md">
                <div>
                    <label for="year" class="block text-sm font-medium text-gray-700 mb-1">Année</label>
                    <select name="year" id="year" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        {% for y in range("now"|date('Y'), "now"|date('Y') - 3) %}
                            <option value="{{ y }}" {% if y == "now"|date('Y') %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="month" class="block text-sm font-medium text-gray-700 mb-1">Mois</label>
                    <select name="month" id="month" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        {% set months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'] %}
                        {% for m in 1..12 %}
                            <option value="{{ m }}" {% if m == "now"|date('n') %}selected{% endif %}>{{ months[m-1] }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        {# Zone de dépôt #}
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Fichiers à déposer</h3>

            <div class="border-2 border-gray-300 border-dashed rounded-lg p-8 text-center hover:border-blue-400 transition cursor-pointer" id="drop-zone">
                <svg class="mx-auto h-16 w-16 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <div class="mt-4">
                    <label class="cursor-pointer">
                        <span class="text-blue-600 hover:text-blue-500 font-medium">Sélectionner des fichiers</span>
                        <input type="file" name="files[]" multiple accept="application/pdf" class="sr-only" id="file-input">
                    </label>
                    <span class="text-gray-600"> ou glisser-déposer</span>
                </div>
                <p class="text-sm text-gray-500 mt-2">Fichiers PDF uniquement</p>
            </div>

            {# Liste des fichiers sélectionnés #}
            <div id="file-list" class="mt-6 hidden">
                <h4 class="font-medium text-gray-900 mb-3">Fichiers sélectionnés (<span id="file-count">0</span>)</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fichier</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Matricule détecté</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Éducateur</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Action</th>
                            </tr>
                        </thead>
                        <tbody id="file-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {# Options #}
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Options</h3>
            <div class="space-y-3">
                <label class="flex items-center">
                    <input type="checkbox" name="notify" value="1" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                    <span class="ml-2 text-sm text-gray-700">Notifier les éducateurs par email</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="skip_unmatched" value="1" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Ignorer les fichiers sans correspondance de matricule</span>
                </label>
            </div>
        </div>

        {# Actions #}
        <div class="flex justify-between items-center">
            <a href="{{ path('admin_payslip_index') }}" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                Annuler
            </a>
            <button type="submit" id="submit-btn" disabled class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                Déposer les fiches
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('file-list');
    const fileTableBody = document.getElementById('file-table-body');
    const fileCount = document.getElementById('file-count');
    const submitBtn = document.getElementById('submit-btn');

    // Données des matricules (à charger depuis le serveur)
    const matricules = {{ matricules|json_encode|raw }};

    let selectedFiles = [];

    // Gestion du drag & drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('border-blue-400', 'bg-blue-50'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('border-blue-400', 'bg-blue-50'), false);
    });

    dropZone.addEventListener('drop', handleDrop, false);
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    function handleDrop(e) {
        const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
        addFiles(files);
    }

    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        addFiles(files);
    }

    function addFiles(files) {
        files.forEach(file => {
            if (!selectedFiles.find(f => f.name === file.name)) {
                selectedFiles.push(file);
            }
        });
        updateFileList();
    }

    function updateFileList() {
        if (selectedFiles.length === 0) {
            fileList.classList.add('hidden');
            submitBtn.disabled = true;
            return;
        }

        fileList.classList.remove('hidden');
        fileCount.textContent = selectedFiles.length;
        fileTableBody.innerHTML = '';

        let validCount = 0;

        selectedFiles.forEach((file, index) => {
            const matricule = extractMatricule(file.name);
            const user = matricule ? matricules[matricule] : null;
            const isValid = !!user;
            if (isValid) validCount++;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-4 py-3 text-sm text-gray-900">${file.name}</td>
                <td class="px-4 py-3 text-sm ${matricule ? 'text-gray-900' : 'text-gray-400'}">${matricule || 'Non détecté'}</td>
                <td class="px-4 py-3 text-sm ${user ? 'text-gray-900' : 'text-red-600'}">${user || 'Non trouvé'}</td>
                <td class="px-4 py-3">
                    ${isValid
                        ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Prêt</span>'
                        : '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">Erreur</span>'
                    }
                </td>
                <td class="px-4 py-3 text-center">
                    <button type="button" onclick="removeFile(${index})" class="text-red-600 hover:text-red-900">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </td>
            `;
            fileTableBody.appendChild(row);
        });

        submitBtn.disabled = validCount === 0;
    }

    function extractMatricule(filename) {
        // Pattern: MATRICULE_YYYY_MM.pdf ou MATRICULE.pdf
        const match = filename.match(/^([A-Z0-9]+)(?:_\d{4}_\d{2})?\.pdf$/i);
        return match ? match[1].toUpperCase() : null;
    }

    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        updateFileList();
    };
});
</script>
{% endblock %}
